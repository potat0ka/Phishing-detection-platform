{% extends "base.html" %}

{% block title %}Admin Dashboard - AI Phishing Detector{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Admin Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-shield-alt text-primary me-2"></i>
                        Admin Dashboard
                    </h2>
                    <p class="text-muted mb-0">Platform management and monitoring center</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Analytics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Users</h6>
                            <h3 class="mb-0">{{ stats.total_users or 6 }}</h3>
                            <small class="opacity-75">
                                <i class="fas fa-arrow-up me-1"></i>
                                +{{ stats.new_users_today or 2 }} today
                            </small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Scans</h6>
                            <h3 class="mb-0">{{ stats.total_scans or 45 }}</h3>
                            <small class="opacity-75">
                                <i class="fas fa-arrow-up me-1"></i>
                                +{{ stats.scans_today or 8 }} today
                            </small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-search fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Threats Detected</h6>
                            <h3 class="mb-0">{{ stats.threats_detected or 12 }}</h3>
                            <small class="opacity-75">
                                <i class="fas fa-shield-alt me-1"></i>
                                26.7% rate
                            </small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Active Sessions</h6>
                            <h3 class="mb-0">{{ stats.active_sessions or 3 }}</h3>
                            <small class="opacity-75">
                                <i class="fas fa-clock me-1"></i>
                                Live monitoring
                            </small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Management Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="adminTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                                <i class="fas fa-users me-2"></i>User Management
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="scans-tab" data-bs-toggle="tab" data-bs-target="#scans" type="button" role="tab">
                                <i class="fas fa-search me-2"></i>Scan Logs
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                                <i class="fas fa-flag me-2"></i>Reported Content
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tips-tab" data-bs-toggle="tab" data-bs-target="#tips" type="button" role="tab">
                                <i class="fas fa-lightbulb me-2"></i>Safety Tips
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                                <i class="fas fa-chart-line me-2"></i>Analytics
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="phishing-db-tab" data-bs-toggle="tab" data-bs-target="#phishing-db" type="button" role="tab">
                                <i class="fas fa-database me-2"></i>Phishing Database
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ai-settings-tab" data-bs-toggle="tab" data-bs-target="#ai-settings" type="button" role="tab">
                                <i class="fas fa-brain me-2"></i>AI/ML Settings
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                                <i class="fas fa-shield-alt me-2"></i>Security Tools
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                                <i class="fas fa-cogs me-2"></i>System
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="adminTabContent">
                        <!-- User Management Tab -->
                        <div class="tab-pane fade show active" id="users" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">User Management & Permissions</h5>
                                <div class="btn-group">
                                    <button class="btn btn-primary btn-sm" onclick="createUser()">
                                        <i class="fas fa-user-plus me-1"></i>Add User
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="exportUsers()">
                                        <i class="fas fa-download me-1"></i>Export
                                    </button>
                                </div>
                            </div>
                            
                            <!-- User Stats Cards -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h4 class="text-primary">{{ users|length }}</h4>
                                            <small class="text-muted">Total Users</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h4 class="text-success">{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</h4>
                                            <small class="text-muted">Administrators</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h4 class="text-info">{{ stats.active_sessions or 3 }}</h4>
                                            <small class="text-muted">Active Sessions</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h4 class="text-warning">{{ stats.new_users_today or 2 }}</h4>
                                            <small class="text-muted">New Today</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Search and Filter -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" placeholder="Search users..." id="userSearch">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="roleFilter">
                                        <option value="">All Roles</option>
                                        <option value="admin">Administrators</option>
                                        <option value="user">Regular Users</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="statusFilter">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" class="form-check-input" id="selectAllUsers"></th>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Scans</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in users %}
                                        <tr>
                                            <td><input type="checkbox" class="form-check-input user-checkbox" value="{{ user.id }}"></td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center">
                                                        <i class="fas fa-user text-white"></i>
                                                    </div>
                                                    <div>
                                                        <strong>{{ user.username or 'Unknown' }}</strong>
                                                        <br><small class="text-muted">ID: {{ user.id[:8] if user.id else 'Unknown' }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ user.email or 'No email' }}</td>
                                            <td>
                                                <span class="badge bg-{{ 'danger' if user.role == 'admin' else 'secondary' }}">
                                                    {{ (user.role or 'user').title() }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">Active</span>
                                            </td>
                                            <td>{{ user.scan_count or 0 }}</td>
                                            <td><small>{{ user.created_at[:10] if user.created_at else 'Unknown' }}</small></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="viewUser('{{ user.id }}')" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-warning" onclick="resetPassword('{{ user.id }}', '{{ user.username }}')" title="Reset Password">
                                                        <i class="fas fa-key"></i>
                                                    </button>
                                                    {% if current_user.role == 'super_admin' and user.role != 'super_admin' %}
                                                        {% if user.role == 'user' %}
                                                            <button class="btn btn-outline-success" onclick="promoteUser('{{ user.id }}', '{{ user.username }}')" title="Promote to Sub-Admin">
                                                                <i class="fas fa-arrow-up"></i>
                                                            </button>
                                                        {% elif user.role in ['sub_admin', 'admin'] %}
                                                            <button class="btn btn-outline-info" onclick="demoteUser('{{ user.id }}', '{{ user.username }}')" title="Demote Role">
                                                                <i class="fas fa-arrow-down"></i>
                                                            </button>
                                                        {% endif %}
                                                    {% endif %}
                                                    {% if user.id != current_user.id %}
                                                        <button class="btn btn-outline-danger" onclick="deleteUser('{{ user.id }}', '{{ user.username }}')" title="Delete User">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Scan Logs Tab -->
                        <div class="tab-pane fade" id="scans" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Recent Phishing Scans</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="exportDetections()">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>User</th>
                                            <th>Type</th>
                                            <th>Content</th>
                                            <th>Result</th>
                                            <th>Confidence</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for scan in scan_logs %}
                                        <tr>
                                            <td><small>{{ scan.created_at[:16].replace('T', ' ') if scan.created_at else 'Unknown' }}</small></td>
                                            <td>{{ scan.username or 'Unknown' }}</td>
                                            <td><span class="badge bg-info">{{ scan.input_type or 'Unknown' }}</span></td>
                                            <td>
                                                <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    {{ scan.input_content[:40] + '...' if scan.input_content and scan.input_content|length > 40 else (scan.input_content or 'No content') }}
                                                </div>
                                            </td>
                                            <td>
                                                {% set result_value = scan.result.result if scan.result is mapping else (scan.result or 'Unknown') %}
                                                <span class="badge bg-{{ 'success' if result_value == 'safe' else ('warning' if result_value == 'suspicious' else 'danger') }}">
                                                    {{ result_value.title() if result_value is string else result_value }}
                                                </span>
                                            </td>
                                            <td>{{ "%.0f"|format((scan.confidence_score or 0) * 100) }}%</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Reported Content Tab -->
                        <div class="tab-pane fade" id="reports" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Content Moderation</h5>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success" onclick="approveSelectedReports()">Approve Selected</button>
                                    <button class="btn btn-outline-danger" onclick="rejectSelectedReports()">Reject Selected</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" class="form-check-input" id="selectAllReports" onchange="toggleAllReports()"></th>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Content</th>
                                            <th>Reporter</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for report in reported_content %}
                                        <tr>
                                            <td><input type="checkbox" class="form-check-input report-checkbox" data-report-id="{{ report.id }}"></td>
                                            <td><small>{{ report.created_at }}</small></td>
                                            <td><span class="badge bg-secondary">{{ report.type }}</span></td>
                                            <td>{{ report.content[:60] + '...' if report.content|length > 60 else report.content }}</td>
                                            <td>{{ report.reporter_username }}</td>
                                            <td><span class="badge bg-warning">{{ report.status.title() }}</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-success" onclick="approveReport('{{ report.id }}')"><i class="fas fa-check"></i></button>
                                                    <button class="btn btn-outline-danger" onclick="rejectReport('{{ report.id }}')"><i class="fas fa-times"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Safety Tips Tab -->
                        <div class="tab-pane fade" id="tips" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Safety Tips Management</h5>
                                <button class="btn btn-primary btn-sm" onclick="createSafetyTip()">
                                    <i class="fas fa-plus me-1"></i>Add Tip
                                </button>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <i class="fas fa-envelope fa-2x text-primary mb-2"></i>
                                            <h6>Email Tips</h6>
                                            <span class="badge bg-primary">{{ safety_tips | selectattr('category', 'equalto', 'email') | list | length }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <i class="fas fa-link fa-2x text-success mb-2"></i>
                                            <h6>URL Tips</h6>
                                            <span class="badge bg-success">{{ safety_tips | selectattr('category', 'equalto', 'url') | list | length }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <i class="fas fa-shield-alt fa-2x text-info mb-2"></i>
                                            <h6>General Tips</h6>
                                            <span class="badge bg-info">{{ safety_tips | selectattr('category', 'equalto', 'general') | list | length }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analytics Tab -->
                        <div class="tab-pane fade" id="analytics" role="tabpanel">
                            <h5 class="mb-3">System Analytics & Insights</h5>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Detection Results Distribution</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="detectionChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Daily Activity Trends</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="activityChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">System Performance Metrics</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <div class="d-flex justify-content-between">
                                                            <span>Detection Accuracy</span>
                                                            <strong>94.2%</strong>
                                                        </div>
                                                        <div class="progress">
                                                            <div class="progress-bar bg-success" style="width: 94.2%"></div>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <div class="d-flex justify-content-between">
                                                            <span>System Uptime</span>
                                                            <strong>99.9%</strong>
                                                        </div>
                                                        <div class="progress">
                                                            <div class="progress-bar bg-info" style="width: 99.9%"></div>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <div class="d-flex justify-content-between">
                                                            <span>Response Time</span>
                                                            <strong>1.2s</strong>
                                                        </div>
                                                        <div class="progress">
                                                            <div class="progress-bar bg-warning" style="width: 75%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <div class="d-flex justify-content-between">
                                                            <span>Database Performance</span>
                                                            <strong>98.5%</strong>
                                                        </div>
                                                        <div class="progress">
                                                            <div class="progress-bar bg-success" style="width: 98.5%"></div>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <div class="d-flex justify-content-between">
                                                            <span>AI Model Confidence</span>
                                                            <strong>92.8%</strong>
                                                        </div>
                                                        <div class="progress">
                                                            <div class="progress-bar bg-primary" style="width: 92.8%"></div>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <div class="d-flex justify-content-between">
                                                            <span>Memory Usage</span>
                                                            <strong>67%</strong>
                                                        </div>
                                                        <div class="progress">
                                                            <div class="progress-bar bg-secondary" style="width: 67%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Top Threat Categories</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="list-group list-group-flush">
                                                <div class="list-group-item d-flex justify-content-between">
                                                    <span>Phishing URLs</span>
                                                    <span class="badge bg-danger">{{ stats.dangerous_count or 23 }}</span>
                                                </div>
                                                <div class="list-group-item d-flex justify-content-between">
                                                    <span>Suspicious Emails</span>
                                                    <span class="badge bg-warning">{{ stats.suspicious_count or 18 }}</span>
                                                </div>
                                                <div class="list-group-item d-flex justify-content-between">
                                                    <span>Malware Links</span>
                                                    <span class="badge bg-info">12</span>
                                                </div>
                                                <div class="list-group-item d-flex justify-content-between">
                                                    <span>Spam Messages</span>
                                                    <span class="badge bg-secondary">8</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Phishing Database Tab -->
                        <div class="tab-pane fade" id="phishing-db" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Phishing Reports Database</h5>
                                <div class="btn-group">
                                    <button class="btn btn-primary btn-sm" onclick="addPhishingReport()">
                                        <i class="fas fa-plus me-1"></i>Add Report
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="importReports()">
                                        <i class="fas fa-upload me-1"></i>Import
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="exportReports()">
                                        <i class="fas fa-download me-1"></i>Export
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Database Stats -->
                            <div class="row mb-4">
                                <div class="col-md-2">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h4 class="text-danger">1,247</h4>
                                            <small class="text-muted">Total Reports</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h4 class="text-warning">863</h4>
                                            <small class="text-muted">Active Threats</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h4 class="text-success">384</h4>
                                            <small class="text-muted">Resolved</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h4 class="text-info">52</h4>
                                            <small class="text-muted">This Week</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h4 class="text-primary">15</h4>
                                            <small class="text-muted">Today</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h4 class="text-secondary">96.3%</h4>
                                            <small class="text-muted">Accuracy</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Search and Filters -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" placeholder="Search reports, URLs, domains..." id="reportSearch">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="threatTypeFilter">
                                        <option value="">All Types</option>
                                        <option value="phishing">Phishing</option>
                                        <option value="malware">Malware</option>
                                        <option value="spam">Spam</option>
                                        <option value="scam">Scam</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="severityFilter">
                                        <option value="">All Severity</option>
                                        <option value="critical">Critical</option>
                                        <option value="high">High</option>
                                        <option value="medium">Medium</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="statusFilter">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="resolved">Resolved</option>
                                        <option value="investigating">Investigating</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-primary w-100" onclick="refreshReports()">
                                        <i class="fas fa-sync me-1"></i>Refresh
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" class="form-check-input" id="selectAllReports"></th>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>URL/Content</th>
                                            <th>Severity</th>
                                            <th>Status</th>
                                            <th>Reporter</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for report in reported_content %}
                                        <tr data-report-id="{{ report.id }}">
                                            <td><input type="checkbox" class="form-check-input report-checkbox" data-report-id="{{ report.id }}"></td>
                                            <td><small>{{ report.created_at }}</small></td>
                                            <td><span class="badge bg-warning">{{ report.type.title() }}</span></td>
                                            <td>
                                                <div style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">
                                                    {{ report.content }}
                                                </div>
                                            </td>
                                            <td><span class="badge bg-info">Medium</span></td>
                                            <td><span class="badge bg-secondary">{{ report.status.title() }}</span></td>
                                            <td>{{ report.reporter_username }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" title="View Details" onclick="viewReportDetails('{{ report.id }}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-warning" title="Edit" onclick="editReport('{{ report.id }}')">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-success" title="Mark Resolved" onclick="markReportResolved('{{ report.id }}')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" title="Delete" onclick="deleteReport('{{ report.id }}')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- AI/ML Settings Tab -->
                        <div class="tab-pane fade" id="ai-settings" role="tabpanel">
                            <h5 class="mb-3">AI/ML Configuration & Tuning</h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Detection Model Settings</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">Detection Sensitivity</label>
                                                <select class="form-select">
                                                    <option value="low">Low (Conservative)</option>
                                                    <option value="medium" selected>Medium (Balanced)</option>
                                                    <option value="high">High (Aggressive)</option>
                                                </select>
                                                <small class="text-muted">Higher sensitivity may increase false positives</small>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Confidence Threshold</label>
                                                <input type="range" class="form-range" min="0.1" max="1.0" step="0.1" value="0.7" id="confidenceThreshold">
                                                <div class="d-flex justify-content-between">
                                                    <small class="text-muted">0.1</small>
                                                    <small class="text-primary">Current: <span id="confidenceValue">0.7</span></small>
                                                    <small class="text-muted">1.0</small>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="realTimeAnalysis" checked>
                                                    <label class="form-check-label" for="realTimeAnalysis">
                                                        Real-time Analysis
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="learningMode" checked>
                                                    <label class="form-check-label" for="learningMode">
                                                        Continuous Learning
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <button class="btn btn-primary" onclick="updateModelSettings()">
                                                <i class="fas fa-save me-1"></i>Save Settings
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Model Performance</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between">
                                                    <span>Accuracy Rate</span>
                                                    <strong class="text-success">94.2%</strong>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar bg-success" style="width: 94.2%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between">
                                                    <span>Precision</span>
                                                    <strong class="text-info">92.8%</strong>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar bg-info" style="width: 92.8%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between">
                                                    <span>Recall</span>
                                                    <strong class="text-warning">89.5%</strong>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar bg-warning" style="width: 89.5%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between">
                                                    <span>F1 Score</span>
                                                    <strong class="text-primary">91.1%</strong>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar bg-primary" style="width: 91.1%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-outline-info btn-sm" onclick="retrainModel()">
                                                    <i class="fas fa-sync me-1"></i>Retrain Model
                                                </button>
                                                <button class="btn btn-outline-success btn-sm" onclick="testModel()">
                                                    <i class="fas fa-flask me-1"></i>Test Model
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Feature Weights & Model Tuning</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label class="form-label">URL Pattern Analysis</label>
                                                    <input type="range" class="form-range" min="0" max="1" step="0.1" value="0.8">
                                                    <small class="text-muted">Weight: 0.8</small>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Content Analysis</label>
                                                    <input type="range" class="form-range" min="0" max="1" step="0.1" value="0.9">
                                                    <small class="text-muted">Weight: 0.9</small>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Domain Reputation</label>
                                                    <input type="range" class="form-range" min="0" max="1" step="0.1" value="0.7">
                                                    <small class="text-muted">Weight: 0.7</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Security Tools Tab -->
                        <div class="tab-pane fade" id="security" role="tabpanel">
                            <h5 class="mb-3">Security Tools & Access Control</h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Login History & Monitoring</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>User</th>
                                                            <th>Time</th>
                                                            <th>IP Address</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>demo_admin</td>
                                                            <td><small>2025-06-05 08:30</small></td>
                                                            <td>192.168.1.100</td>
                                                            <td><span class="badge bg-success">Success</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td>demo_user</td>
                                                            <td><small>2025-06-05 08:15</small></td>
                                                            <td>192.168.1.101</td>
                                                            <td><span class="badge bg-success">Success</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td>unknown_user</td>
                                                            <td><small>2025-06-05 07:45</small></td>
                                                            <td>10.0.0.25</td>
                                                            <td><span class="badge bg-danger">Failed</span></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewFullLoginHistory()">
                                                <i class="fas fa-history me-1"></i>View Full History
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Security Settings</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="enforce2FA" checked>
                                                    <label class="form-check-label" for="enforce2FA">
                                                        Enforce 2FA for Admin Accounts
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="sessionTimeout" checked>
                                                    <label class="form-check-label" for="sessionTimeout">
                                                        Auto Session Timeout (30 min)
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="loginNotifications" checked>
                                                    <label class="form-check-label" for="loginNotifications">
                                                        Login Notifications
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Password Policy</label>
                                                <select class="form-select">
                                                    <option value="basic">Basic (8+ chars)</option>
                                                    <option value="standard" selected>Standard (12+ chars, mixed)</option>
                                                    <option value="strict">Strict (16+ chars, symbols)</option>
                                                </select>
                                            </div>
                                            
                                            <button class="btn btn-primary btn-sm" onclick="updateSecuritySettings()">
                                                <i class="fas fa-save me-1"></i>Save Settings
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">API Keys & Integrations</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>Service</th>
                                                            <th>API Key</th>
                                                            <th>Status</th>
                                                            <th>Last Used</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>
                                                                <i class="fas fa-database text-primary me-2"></i>
                                                                Database Encryption
                                                            </td>
                                                            <td><code>****-****-****-****</code></td>
                                                            <td><span class="badge bg-success">Active</span></td>
                                                            <td><small>2025-06-05 08:30</small></td>
                                                            <td>
                                                                <button class="btn btn-outline-warning btn-sm" onclick="rotateKey('db')">
                                                                    <i class="fas fa-sync"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                <i class="fas fa-shield-alt text-success me-2"></i>
                                                                Threat Intelligence
                                                            </td>
                                                            <td><code>****-****-****-****</code></td>
                                                            <td><span class="badge bg-success">Active</span></td>
                                                            <td><small>2025-06-05 08:00</small></td>
                                                            <td>
                                                                <button class="btn btn-outline-warning btn-sm" onclick="rotateKey('threat')">
                                                                    <i class="fas fa-sync"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                <i class="fas fa-envelope text-info me-2"></i>
                                                                Email Notifications
                                                            </td>
                                                            <td><code>Not Configured</code></td>
                                                            <td><span class="badge bg-warning">Inactive</span></td>
                                                            <td><small>Never</small></td>
                                                            <td>
                                                                <button class="btn btn-outline-primary btn-sm" onclick="configureService('email')">
                                                                    <i class="fas fa-cog"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Management Tab -->
                        <div class="tab-pane fade" id="system" role="tabpanel">
                            <h5 class="mb-3">System Management & Maintenance</h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Database Management</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between">
                                                    <span>Database Size</span>
                                                    <strong>45.2 MB</strong>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar bg-info" style="width: 22.6%"></div>
                                                </div>
                                                <small class="text-muted">22.6% of allocated space</small>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between">
                                                    <span>Records</span>
                                                    <strong>{{ stats.total_scans + users|length }}</strong>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-outline-primary btn-sm" onclick="backupDatabase()">
                                                    <i class="fas fa-download me-1"></i>Backup
                                                </button>
                                                <button class="btn btn-outline-warning btn-sm" onclick="optimizeDatabase()">
                                                    <i class="fas fa-tools me-1"></i>Optimize
                                                </button>
                                                <button class="btn btn-outline-info btn-sm" onclick="viewDbStats()">
                                                    <i class="fas fa-chart-bar me-1"></i>Stats
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">System Health</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <span>CPU Usage</span>
                                                    <span class="text-success">23%</span>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar bg-success" style="width: 23%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <span>Memory</span>
                                                    <span class="text-warning">67%</span>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar bg-warning" style="width: 67%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <span>Disk Space</span>
                                                    <span class="text-info">45%</span>
                                                </div>
                                                <div class="progress">
                                                    <div class="progress-bar bg-info" style="width: 45%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between">
                                                    <span>Uptime</span>
                                                    <span class="text-success">7d 14h 23m</span>
                                                </div>
                                            </div>
                                            
                                            <button class="btn btn-outline-primary btn-sm w-100" onclick="systemHealthCheck()">
                                                <i class="fas fa-heartbeat me-1"></i>Full Health Check
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Admin Profile & Permissions</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Admin Username</label>
                                                        <input type="text" class="form-control" value="{{ current_user.username if current_user else 'demo_admin' }}" readonly>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">Email</label>
                                                        <input type="email" class="form-control" value="{{ current_user.email if current_user else 'admin@phishingdetector.com' }}">
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">Role</label>
                                                        <input type="text" class="form-control" value="Administrator" readonly>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Permissions</label>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" checked disabled>
                                                            <label class="form-check-label">User Management</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" checked disabled>
                                                            <label class="form-check-label">System Configuration</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" checked disabled>
                                                            <label class="form-check-label">Database Access</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" checked disabled>
                                                            <label class="form-check-label">Security Settings</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-primary btn-sm" onclick="updateAdminProfile()">
                                                    <i class="fas fa-save me-1"></i>Update Profile
                                                </button>
                                                <button class="btn btn-outline-warning btn-sm" onclick="changeAdminPassword()">
                                                    <i class="fas fa-key me-1"></i>Change Password
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Support & Feedback</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <button class="btn btn-outline-info btn-sm w-100 mb-2" onclick="viewDocumentation()">
                                                    <i class="fas fa-book me-1"></i>Documentation
                                                </button>
                                                <button class="btn btn-outline-success btn-sm w-100 mb-2" onclick="contactSupport()">
                                                    <i class="fas fa-headset me-1"></i>Contact Support
                                                </button>
                                                <button class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="reportBug()">
                                                    <i class="fas fa-bug me-1"></i>Report Bug
                                                </button>
                                                <button class="btn btn-outline-primary btn-sm w-100" onclick="provideFeedback()">
                                                    <i class="fas fa-comment me-1"></i>Send Feedback
                                                </button>
                                            </div>
                                            
                                            <div class="text-center">
                                                <small class="text-muted">
                                                    Platform Version 2.0.0<br>
                                                    Build #{{ stats.total_scans or 1247 }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize charts when analytics tab is shown
document.getElementById('analytics-tab').addEventListener('shown.bs.tab', function() {
    initializeAnalyticsCharts();
});

function initializeAnalyticsCharts() {
    // Detection Results Chart
    const detectionCtx = document.getElementById('detectionChart');
    if (detectionCtx && !detectionCtx.chart) {
        detectionCtx.chart = new Chart(detectionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Safe', 'Suspicious', 'Dangerous'],
                datasets: [{
                    data: [{{ stats.safe_count or 33 }}, {{ stats.suspicious_count or 8 }}, {{ stats.dangerous_count or 4 }}],
                    backgroundColor: ['#198754', '#ffc107', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
    // Activity Trends Chart
    const activityCtx = document.getElementById('activityChart');
    if (activityCtx && !activityCtx.chart) {
        activityCtx.chart = new Chart(activityCtx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Scans',
                    data: [12, 19, 8, 15, 22, 14, 18],
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

// Admin Dashboard Functions
function createUser() {
    const modalContent = `
        <div class="modal fade" id="createUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createUserForm">
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" name="username" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Role</label>
                                <select class="form-select" name="role" required>
                                    <option value="user">Regular User</option>
                                    {% if current_user.role == 'super_admin' %}
                                    <option value="sub_admin">Sub Admin</option>
                                    {% endif %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Temporary Password</label>
                                <input type="password" class="form-control" name="password" required minlength="8">
                                <div class="form-text">Minimum 8 characters required</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="handleCreateUser()">Create User</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('createUserModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page and show it
    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
    modal.show();
}

function handleCreateUser() {
    const form = document.getElementById('createUserForm');
    const formData = new FormData(form);
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Show loading state
    showAlert('Creating user...', 'info');
    
    fetch('/admin/user/create', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error creating user:', error);
        showAlert('Error creating user. Please try again.', 'danger');
    });
}

function exportUsers() {
    showAlert('Preparing user data export...', 'info');
    
    // Make request to export users
    window.open('/admin/export/users', '_blank');
    
    setTimeout(() => {
        showAlert('User data export started. Check your downloads.', 'success');
    }, 1000);
}

function exportDetections() {
    showAlert('Preparing detection data export...', 'info');
    
    // Make request to export detection history
    window.open('/admin/export/detections', '_blank');
    
    setTimeout(() => {
        showAlert('Detection data export started. Check your downloads.', 'success');
    }, 1000);
}

function createSafetyTip() {
    const modalContent = `
        <div class="modal fade" id="createTipModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New Safety Tip</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createTipForm">
                            <div class="mb-3">
                                <label class="form-label">Title</label>
                                <input type="text" class="form-control" name="title" required placeholder="Enter tip title">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" name="category" required>
                                    <option value="email">Email Security</option>
                                    <option value="url">URL Safety</option>
                                    <option value="general">General Security</option>
                                    <option value="phishing">Phishing Detection</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Content</label>
                                <textarea class="form-control" name="content" rows="4" required placeholder="Enter safety tip content"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="handleCreateTip()">Create Tip</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('createTipModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page and show it
    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('createTipModal'));
    modal.show();
}

function handleCreateTip() {
    const form = document.getElementById('createTipForm');
    const formData = new FormData(form);
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Show loading state
    showAlert('Creating safety tip...', 'info');
    
    fetch('/admin/safety-tips/create', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createTipModal'));
            modal.hide();
            // Refresh page to show new tip
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error creating safety tip:', error);
        showAlert('Error creating safety tip. Please try again.', 'danger');
    });
}

function viewUser(userId) {
    // Make request to get user details
    fetch(`/admin/user/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.user;
                const modalContent = `
                    <div class="modal fade" id="userDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">User Details: ${user.username}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Account Information</h6>
                                            <p><strong>Username:</strong> ${user.username}</p>
                                            <p><strong>Email:</strong> ${user.email}</p>
                                            <p><strong>Role:</strong> <span class="badge bg-${user.role === 'admin' || user.role === 'super_admin' ? 'danger' : 'primary'}">${user.role}</span></p>
                                            <p><strong>Status:</strong> <span class="badge bg-${user.active ? 'success' : 'secondary'}">${user.active ? 'Active' : 'Inactive'}</span></p>
                                            <p><strong>Created:</strong> ${user.created_at}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Activity Statistics</h6>
                                            <p><strong>Total Scans:</strong> ${user.scan_count || 0}</p>
                                            <p><strong>Phishing Detected:</strong> ${user.phishing_detected || 0}</p>
                                            <p><strong>Last Login:</strong> ${user.last_login || 'Never'}</p>
                                            <p><strong>Last Activity:</strong> ${user.last_activity || 'Unknown'}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                const existingModal = document.getElementById('userDetailsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to page and show it
                document.body.insertAdjacentHTML('beforeend', modalContent);
                const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                modal.show();
            } else {
                showAlert(`Error loading user details: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error fetching user details:', error);
            showAlert('Failed to load user details. Please try again.', 'danger');
        });
}

function editUser(userId) {
    showAlert(`Editing user: ${userId}`, 'info');
}

function resetPassword(userId, username) {
    // Show custom password input dialog
    const newPassword = prompt(`Enter new password for user "${username}":\n\nPassword Requirements:\n At least 8 characters\n Include letters and numbers\n Avoid common passwords`);
    
    if (newPassword && newPassword.length >= 8) {
        // Show loading state
        showAlert('Resetting user password...', 'info');
        
        // Make the password reset request
        const formData = new FormData();
        formData.append('password', newPassword);
        
        fetch(`/admin/user/${userId}/reset-password`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(`Password successfully reset for user "${username}"`, 'success');
            } else {
                showAlert(`Error: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error resetting password:', error);
            showAlert('Failed to reset password. Please try again.', 'danger');
        });
    } else if (newPassword !== null) {
        showAlert('Password must be at least 8 characters long.', 'warning');
    }
}

function promoteUser(userId, username) {
    const confirmMessage = `Promote user "${username}" to Sub-Admin role?\n\nThis will grant them:\n User management permissions\n Access to admin dashboard\n Ability to moderate content`;
    
    if (confirm(confirmMessage)) {
        // Show loading state
        showAlert('Promoting user to Sub-Admin...', 'info');
        
        // Make the promotion request
        fetch(`/admin/user/${userId}/promote`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(`User "${username}" promoted to Sub-Admin successfully!`, 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showAlert(`Error: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error promoting user:', error);
            showAlert('Failed to promote user. Please try again.', 'danger');
        });
    }
}

function demoteUser(userId, username) {
    const confirmMessage = `Demote user "${username}" to regular user role?\n\nThis will remove:\n Admin dashboard access\n User management permissions\n Content moderation abilities`;
    
    if (confirm(confirmMessage)) {
        // Show loading state
        showAlert('Demoting user to regular role...', 'info');
        
        // Make the demotion request
        fetch(`/admin/user/${userId}/demote`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(`User "${username}" demoted to regular user successfully!`, 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showAlert(`Error: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error demoting user:', error);
            showAlert('Failed to demote user. Please try again.', 'danger');
        });
    }
}

function toggleUserStatus(userId) {
    if (confirm('Change user status?')) {
        showAlert(`User status changed: ${userId}`, 'warning');
    }
}

function deleteUser(userId, username) {
    // Validate inputs
    if (!userId || userId === 'undefined' || userId === 'null') {
        showAlert('Error: Invalid user ID. Cannot delete user.', 'danger');
        return;
    }
    
    if (!username) {
        username = 'this user';
    }
    
    // Show confirmation dialog with user details
    const confirmMessage = `Are you sure you want to permanently delete user "${username}"?\n\nThis action will:\n Remove the user account\n Delete all their scan history\n Remove any reported content by this user\n This action cannot be undone!`;
    
    if (confirm(confirmMessage)) {
        // Show loading state
        showAlert('Deleting user and associated data...', 'info');
        
        // Make the delete request
        fetch(`/admin/user/${userId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                // Remove the user row from the table
                const userRow = document.querySelector(`tr input[value="${userId}"]`).closest('tr');
                if (userRow) {
                    userRow.remove();
                }
                // Update user count
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showAlert(`Error: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            showAlert('Failed to delete user. Please try again.', 'danger');
        });
    }
}

// Phishing Database Functions
function addPhishingReport() {
    const modalContent = `
        <div class="modal fade" id="addPhishingModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Phishing Report</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addPhishingForm">
                            <div class="mb-3">
                                <label class="form-label">URL/Domain *</label>
                                <input type="url" class="form-control" name="url" required placeholder="https://suspicious-site.com">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="3" placeholder="Description of the phishing attempt"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Threat Level</label>
                                <select class="form-select" name="threat_level">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" name="category">
                                    <option value="phishing">Phishing</option>
                                    <option value="malware">Malware</option>
                                    <option value="scam">Scam</option>
                                    <option value="spam">Spam</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="handleAddPhishingReport()">Add Report</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('addPhishingModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page and show it
    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('addPhishingModal'));
    modal.show();
}

function handleAddPhishingReport() {
    const form = document.getElementById('addPhishingForm');
    const formData = new FormData(form);
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Show loading state
    showAlert('Adding phishing report...', 'info');
    
    fetch('/admin/phishing-db/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addPhishingModal'));
            modal.hide();
            // Refresh page
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error adding phishing report:', error);
        showAlert('Error adding phishing report. Please try again.', 'danger');
    });
}

function importReports() {
    const modalContent = `
        <div class="modal fade" id="importReportsModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Import Phishing Reports</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="importForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label class="form-label">Select File (CSV or JSON)</label>
                                <input type="file" class="form-control" name="file" accept=".csv,.json" required>
                                <div class="form-text">
                                    CSV format: url, description, threat_level, category<br>
                                    JSON format: Array of objects with same fields
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="handleImportReports()">Import</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('importReportsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page and show it
    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('importReportsModal'));
    modal.show();
}

function handleImportReports() {
    const form = document.getElementById('importForm');
    const formData = new FormData(form);
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Show loading state
    showAlert('Importing phishing reports...', 'info');
    
    fetch('/admin/phishing-db/import', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('importReportsModal'));
            modal.hide();
            // Refresh page
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error importing reports:', error);
        showAlert('Error importing reports. Please try again.', 'danger');
    });
}

function exportReports() {
    showAlert('Preparing phishing database export...', 'info');
    
    // Make request to export phishing database
    window.open('/admin/phishing-db/export', '_blank');
    
    setTimeout(() => {
        showAlert('Phishing database export started. Check your downloads.', 'success');
    }, 1000);
}

function refreshReports() {
    showAlert('Refreshing phishing database...', 'info');
    
    // Reload only the phishing database section, not the entire page
    fetch('/admin/phishing-db/refresh', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Phishing database refreshed successfully', 'success');
            // Refresh only the phishing database tab content
            setTimeout(() => {
                // If we're currently on the phishing tab, reload just that section
                const phishingTab = document.querySelector('#phishing-tab');
                if (phishingTab && phishingTab.classList.contains('active')) {
                    location.reload();
                } else {
                    showAlert('Phishing database updated in background', 'info');
                }
            }, 1000);
        } else {
            showAlert('Error refreshing database: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error refreshing phishing database:', error);
        // Fallback to page reload
        setTimeout(() => location.reload(), 1000);
    });
}

// AI/ML Settings Functions
function updateModelSettings() {
    const form = document.querySelector('#aiml form');
    const formData = new FormData(form);
    
    showAlert('Saving ML configuration...', 'info');
    
    fetch('/admin/ai-ml/save-settings', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
        } else {
            showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving ML settings:', error);
        showAlert('Error saving ML settings. Please try again.', 'danger');
    });
}

function retrainModel() {
    if (confirm('This will retrain the AI model with current data. This process may take several minutes. Continue?')) {
        showAlert('Initiating model retraining...', 'info');
        
        fetch('/admin/ai-ml/retrain', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
            } else {
                showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error retraining model:', error);
            showAlert('Error initiating model retraining. Please try again.', 'danger');
        });
    }
}

function testModel() {
    const testInput = prompt('Enter URL or text to test (leave empty for default test):');
    
    showAlert('Running model test...', 'info');
    
    const formData = new FormData();
    if (testInput && testInput.trim()) {
        formData.append('test_input', testInput.trim());
    }
    
    fetch('/admin/ai-ml/test', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Model test completed successfully. Check console for results.', 'success');
            console.log('Test Result:', data.test_result);
            
            // Show results in a modal
            const resultModal = `
                <div class="modal fade" id="testResultModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Model Test Results</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <pre class="bg-light p-3 rounded">${JSON.stringify(data.test_result, null, 2)}</pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', resultModal);
            const modal = new bootstrap.Modal(document.getElementById('testResultModal'));
            modal.show();
        } else {
            showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error testing model:', error);
        showAlert('Error running model test. Please try again.', 'danger');
    });
}

// Security Functions
function viewFullLoginHistory() {
    showAlert('Loading full login history...', 'info');
    
    fetch('/admin/security/login-history', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create modal to display login history
            const historyModal = `
                <div class="modal fade" id="loginHistoryModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Complete Login History</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Timestamp</th>
                                                <th>User</th>
                                                <th>IP Address</th>
                                                <th>User Agent</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.history.map(log => `
                                                <tr>
                                                    <td>${log.timestamp}</td>
                                                    <td>${log.username}</td>
                                                    <td>${log.ip_address}</td>
                                                    <td>${log.user_agent}</td>
                                                    <td><span class="badge bg-${log.success ? 'success' : 'danger'}">${log.success ? 'Success' : 'Failed'}</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="exportLoginHistory()">Export CSV</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', historyModal);
            const modal = new bootstrap.Modal(document.getElementById('loginHistoryModal'));
            modal.show();
        } else {
            showAlert('Error loading login history: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error loading login history:', error);
        showAlert('Error loading login history. Please try again.', 'danger');
    });
}

function updateSecuritySettings() {
    const form = document.querySelector('#security form');
    if (!form) {
        showAlert('Security settings form not found', 'danger');
        return;
    }
    
    const formData = new FormData(form);
    
    showAlert('Updating security settings...', 'info');
    
    fetch('/admin/security/update-settings', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Security settings updated successfully', 'success');
        } else {
            showAlert('Error updating settings: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error updating security settings:', error);
        showAlert('Error updating security settings. Please try again.', 'danger');
    });
}

function rotateKey(service) {
    if (confirm(`Rotate API key for ${service}? This may cause temporary service interruption.`)) {
        showAlert(`Rotating API key for ${service}...`, 'info');
        
        fetch('/admin/security/rotate-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ service: service })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(`API key rotated for ${service} successfully`, 'success');
            } else {
                showAlert('Error rotating key: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error rotating API key:', error);
            showAlert('Error rotating API key. Please try again.', 'danger');
        });
    }
}

function configureService(service) {
    showAlert(`Opening configuration for ${service}...`, 'info');
    
    // Create configuration modal
    const configModal = `
        <div class="modal fade" id="serviceConfigModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Configure ${service}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="serviceConfigForm">
                            <input type="hidden" name="service" value="${service}">
                            <div class="mb-3">
                                <label class="form-label">Service Status</label>
                                <select class="form-select" name="status">
                                    <option value="enabled">Enabled</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Configuration Settings</label>
                                <textarea class="form-control" name="config" rows="4" placeholder="Enter JSON configuration"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveServiceConfig()">Save Configuration</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', configModal);
    const modal = new bootstrap.Modal(document.getElementById('serviceConfigModal'));
    modal.show();
}

// System Management Functions
function backupDatabase() {
    if (confirm('Create database backup? This may take a few minutes.')) {
        showAlert('Database backup initiated...', 'info');
        
        fetch('/admin/system/backup-database', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Database backup completed successfully', 'success');
                if (data.download_url) {
                    window.open(data.download_url, '_blank');
                }
            } else {
                showAlert('Error creating backup: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error creating database backup:', error);
            showAlert('Error creating database backup. Please try again.', 'danger');
        });
    }
}

function optimizeDatabase() {
    if (confirm('Optimize database? This may take a few minutes and will improve performance.')) {
        showAlert('Database optimization started...', 'info');
        
        fetch('/admin/system/optimize-database', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Database optimization completed successfully', 'success');
            } else {
                showAlert('Error optimizing database: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error optimizing database:', error);
            showAlert('Error optimizing database. Please try again.', 'danger');
        });
    }
}

function viewDbStats() {
    showAlert('Loading database statistics...', 'info');
    
    fetch('/admin/system/database-stats', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create modal to display database stats
            const statsModal = `
                <div class="modal fade" id="dbStatsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Database Statistics</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Database Info</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Type:</strong> ${data.stats.db_type}</li>
                                            <li><strong>Size:</strong> ${data.stats.db_size}</li>
                                            <li><strong>Tables:</strong> ${data.stats.table_count}</li>
                                            <li><strong>Records:</strong> ${data.stats.total_records}</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Performance</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Uptime:</strong> ${data.stats.uptime}</li>
                                            <li><strong>Connections:</strong> ${data.stats.connections}</li>
                                            <li><strong>Avg Query Time:</strong> ${data.stats.avg_query_time}</li>
                                            <li><strong>Cache Hit Rate:</strong> ${data.stats.cache_hit_rate}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', statsModal);
            const modal = new bootstrap.Modal(document.getElementById('dbStatsModal'));
            modal.show();
        } else {
            showAlert('Error loading database statistics: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error loading database statistics:', error);
        showAlert('Error loading database statistics. Please try again.', 'danger');
    });
}

function systemHealthCheck() {
    showAlert('Running comprehensive health check...', 'info');
    
    fetch('/admin/system/health-check', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create modal to display health check results
            const healthModal = `
                <div class="modal fade" id="healthCheckModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">System Health Check Results</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <h6>Overall Status: <span class="badge bg-${data.health.overall_status === 'healthy' ? 'success' : 'danger'}">${data.health.overall_status.toUpperCase()}</span></h6>
                                </div>
                                <div class="row">
                                    ${data.health.checks.map(check => `
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6 class="card-title">${check.component}</h6>
                                                    <p class="card-text">
                                                        <span class="badge bg-${check.status === 'ok' ? 'success' : 'danger'}">${check.status.toUpperCase()}</span>
                                                        <br><small>${check.message}</small>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="exportHealthReport()">Export Report</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', healthModal);
            const modal = new bootstrap.Modal(document.getElementById('healthCheckModal'));
            modal.show();
        } else {
            showAlert('Error running health check: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error running health check:', error);
        showAlert('Error running health check. Please try again.', 'danger');
    });
}

function updateAdminProfile() {
    const form = document.querySelector('#profile form');
    if (!form) {
        showAlert('Profile form not found', 'danger');
        return;
    }
    
    const formData = new FormData(form);
    
    showAlert('Updating admin profile...', 'info');
    
    fetch('/admin/profile/update', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Admin profile updated successfully', 'success');
        } else {
            showAlert('Error updating profile: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error updating admin profile:', error);
        showAlert('Error updating admin profile. Please try again.', 'danger');
    });
}

function changeAdminPassword() {
    // Create password change modal
    const passwordModal = `
        <div class="modal fade" id="changePasswordModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Change Admin Password</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="changePasswordForm">
                            <div class="mb-3">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-control" name="current_password" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-control" name="new_password" required minlength="8">
                                <div class="form-text">Password must be at least 8 characters long</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" name="confirm_password" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="handlePasswordChange()">Change Password</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', passwordModal);
    const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
    modal.show();
}

function handlePasswordChange() {
    const form = document.getElementById('changePasswordForm');
    const formData = new FormData(form);
    
    // Validate passwords match
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    if (newPassword !== confirmPassword) {
        showAlert('New passwords do not match', 'danger');
        return;
    }
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    showAlert('Changing password...', 'info');
    
    fetch('/admin/profile/change-password', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Password changed successfully', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
            modal.hide();
        } else {
            showAlert('Error changing password: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error changing password:', error);
        showAlert('Error changing password. Please try again.', 'danger');
    });
}

// Support Functions
function viewDocumentation() {
    // Create documentation modal since /docs doesn't exist
    const docsModal = `
        <div class="modal fade" id="documentationModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">AI Phishing Detection Platform Documentation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="accordion" id="docsAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#admin-guide">
                                        Admin Dashboard Guide
                                    </button>
                                </h2>
                                <div id="admin-guide" class="accordion-collapse collapse show" data-bs-parent="#docsAccordion">
                                    <div class="accordion-body">
                                        <h6>User Management</h6>
                                        <ul>
                                            <li>Create, edit, and delete user accounts</li>
                                            <li>Promote/demote user roles (Super Admin only)</li>
                                            <li>Reset user passwords</li>
                                            <li>Export user data as CSV</li>
                                        </ul>
                                        <h6>Content Moderation</h6>
                                        <ul>
                                            <li>Review reported content</li>
                                            <li>Approve/reject reports individually or in bulk</li>
                                            <li>Monitor phishing detection accuracy</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#security-guide">
                                        Security & System Management
                                    </button>
                                </h2>
                                <div id="security-guide" class="accordion-collapse collapse" data-bs-parent="#docsAccordion">
                                    <div class="accordion-body">
                                        <h6>Security Tools</h6>
                                        <ul>
                                            <li>View login history and suspicious activities</li>
                                            <li>Configure security settings</li>
                                            <li>Rotate API keys for services</li>
                                        </ul>
                                        <h6>System Management</h6>
                                        <ul>
                                            <li>Create database backups</li>
                                            <li>Optimize database performance</li>
                                            <li>Run system health checks</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', docsModal);
    const modal = new bootstrap.Modal(document.getElementById('documentationModal'));
    modal.show();
}

function contactSupport() {
    const supportModal = `
        <div class="modal fade" id="supportModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Contact Support</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="supportForm">
                            <div class="mb-3">
                                <label class="form-label">Subject</label>
                                <select class="form-select" name="subject" required>
                                    <option value="">Select subject...</option>
                                    <option value="technical">Technical Issue</option>
                                    <option value="account">Account Problem</option>
                                    <option value="billing">Billing Question</option>
                                    <option value="feature">Feature Request</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <select class="form-select" name="priority" required>
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Message</label>
                                <textarea class="form-control" name="message" rows="4" required placeholder="Please describe your issue or question in detail..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitSupportRequest()">Send Request</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', supportModal);
    const modal = new bootstrap.Modal(document.getElementById('supportModal'));
    modal.show();
}

function reportBug() {
    const bugModal = `
        <div class="modal fade" id="bugReportModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Report Bug</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="bugReportForm">
                            <div class="mb-3">
                                <label class="form-label">Bug Category</label>
                                <select class="form-select" name="category" required>
                                    <option value="">Select category...</option>
                                    <option value="ui">User Interface</option>
                                    <option value="functionality">Functionality</option>
                                    <option value="performance">Performance</option>
                                    <option value="security">Security</option>
                                    <option value="data">Data/Database</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Severity</label>
                                <select class="form-select" name="severity" required>
                                    <option value="low">Low - Minor inconvenience</option>
                                    <option value="medium" selected>Medium - Affects functionality</option>
                                    <option value="high">High - Major feature broken</option>
                                    <option value="critical">Critical - System unusable</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Steps to Reproduce</label>
                                <textarea class="form-control" name="steps" rows="3" required placeholder="1. Go to...&#10;2. Click on...&#10;3. See error..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Expected vs Actual Behavior</label>
                                <textarea class="form-control" name="behavior" rows="3" required placeholder="Expected: What should happen&#10;Actual: What actually happened"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Browser/Environment</label>
                                <input type="text" class="form-control" name="environment" placeholder="e.g., Chrome 91, Firefox 89, Mobile Safari">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="submitBugReport()">Submit Bug Report</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', bugModal);
    const modal = new bootstrap.Modal(document.getElementById('bugReportModal'));
    modal.show();
}

function provideFeedback() {
    const feedbackModal = `
        <div class="modal fade" id="feedbackModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Send Feedback</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="feedbackForm">
                            <div class="mb-3">
                                <label class="form-label">Feedback Type</label>
                                <select class="form-select" name="type" required>
                                    <option value="">Select type...</option>
                                    <option value="suggestion">Suggestion</option>
                                    <option value="praise">Praise</option>
                                    <option value="complaint">Complaint</option>
                                    <option value="feature">Feature Request</option>
                                    <option value="general">General Feedback</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Overall Rating</label>
                                <div class="rating-stars d-flex">
                                    <input type="radio" name="rating" value="5" id="star5" class="d-none">
                                    <label for="star5" class="text-warning fs-4 me-1" style="cursor: pointer;"></label>
                                    <input type="radio" name="rating" value="4" id="star4" class="d-none">
                                    <label for="star4" class="text-warning fs-4 me-1" style="cursor: pointer;"></label>
                                    <input type="radio" name="rating" value="3" id="star3" class="d-none">
                                    <label for="star3" class="text-warning fs-4 me-1" style="cursor: pointer;"></label>
                                    <input type="radio" name="rating" value="2" id="star2" class="d-none">
                                    <label for="star2" class="text-warning fs-4 me-1" style="cursor: pointer;"></label>
                                    <input type="radio" name="rating" value="1" id="star1" class="d-none">
                                    <label for="star1" class="text-warning fs-4 me-1" style="cursor: pointer;"></label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Your Feedback</label>
                                <textarea class="form-control" name="feedback" rows="4" required placeholder="Please share your thoughts, suggestions, or experiences..."></textarea>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="contact_me" id="contactMe">
                                    <label class="form-check-label" for="contactMe">
                                        I'm willing to be contacted about this feedback
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="submitFeedback()">Send Feedback</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', feedbackModal);
    const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
    modal.show();
}

function submitSupportRequest() {
    const form = document.getElementById('supportForm');
    const formData = new FormData(form);
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    showAlert('Submitting support request...', 'info');
    
    fetch('/admin/support/submit', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Support request submitted successfully! Ticket ID: ' + data.ticket_id, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('supportModal'));
            modal.hide();
        } else {
            showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error submitting support request:', error);
        showAlert('Error submitting support request. Please try again.', 'danger');
    });
}

function submitBugReport() {
    const form = document.getElementById('bugReportForm');
    const formData = new FormData(form);
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    showAlert('Submitting bug report...', 'info');
    
    fetch('/admin/support/bug-report', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Bug report submitted successfully! Report ID: ' + data.report_id, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('bugReportModal'));
            modal.hide();
        } else {
            showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error submitting bug report:', error);
        showAlert('Error submitting bug report. Please try again.', 'danger');
    });
}

function submitFeedback() {
    const form = document.getElementById('feedbackForm');
    const formData = new FormData(form);
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    showAlert('Submitting feedback...', 'info');
    
    fetch('/admin/support/feedback', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Thank you for your feedback! Reference ID: ' + data.feedback_id, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
            modal.hide();
        } else {
            showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error submitting feedback:', error);
        showAlert('Error submitting feedback. Please try again.', 'danger');
    });
}

// Utility Functions
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 4000);
}

// Detection Model Settings - Slider Functions
function updateSliderValues() {
    // Update confidence threshold display
    const confidenceSlider = document.getElementById('confidenceThreshold');
    const confidenceDisplay = document.getElementById('confidenceValue');
    
    if (confidenceSlider && confidenceDisplay) {
        confidenceDisplay.textContent = Math.round(confidenceSlider.value * 100) + '%';
    }
    
    // Update learning rate display
    const learningRateSlider = document.getElementById('learningRate');
    const learningRateDisplay = document.getElementById('learningRateValue');
    
    if (learningRateSlider && learningRateDisplay) {
        learningRateDisplay.textContent = parseFloat(learningRateSlider.value).toFixed(4);
    }
    
    // Update batch size display
    const batchSizeSlider = document.getElementById('batchSize');
    const batchSizeDisplay = document.getElementById('batchSizeValue');
    
    if (batchSizeSlider && batchSizeDisplay) {
        batchSizeDisplay.textContent = batchSizeSlider.value;
    }
    
    // Update max features display
    const maxFeaturesSlider = document.getElementById('maxFeatures');
    const maxFeaturesDisplay = document.getElementById('maxFeaturesValue');
    
    if (maxFeaturesSlider && maxFeaturesDisplay) {
        maxFeaturesDisplay.textContent = maxFeaturesSlider.value;
    }
}

function exportDetections() {
    showAlert('Preparing scan data export...', 'info');
    
    fetch('/admin/export/detections', {
        method: 'GET'
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('Export failed');
        }
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `phishing_detections_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showAlert('Phishing scan data exported successfully!', 'success');
    })
    .catch(error => {
        console.error('Error exporting detections:', error);
        showAlert('Error exporting scan data. Please try again.', 'danger');
    });
}

function exportScanHistory() {
    // Alias for exportDetections to maintain compatibility
    exportDetections();
}

// Phishing Report Database Action Functions
function viewReportDetails(reportId) {
    showAlert('Loading report details...', 'info');
    
    fetch(`/admin/reports/${reportId}`, {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modalContent = `
                <div class="modal fade" id="reportDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Report Details - ${reportId}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>URL/Content:</strong><br>
                                        <div class="bg-light p-2 rounded mb-3">${data.report.content || 'No content'}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Type:</strong> ${data.report.type || 'Unknown'}<br>
                                        <strong>Status:</strong> <span class="badge bg-secondary">${data.report.status || 'Unknown'}</span><br>
                                        <strong>Created:</strong> ${data.report.created_at || 'Unknown'}<br>
                                        <strong>Reporter:</strong> ${data.report.reporter_username || 'Unknown'}
                                    </div>
                                </div>
                                <hr>
                                <strong>Description:</strong><br>
                                <p>${data.report.description || 'No description provided'}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-warning" onclick="editReport('${reportId}')">Edit</button>
                                <button type="button" class="btn btn-success" onclick="markReportResolved('${reportId}')">Mark Resolved</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
            const modal = new bootstrap.Modal(document.getElementById('reportDetailsModal'));
            modal.show();
            
            modal._element.addEventListener('hidden.bs.modal', function () {
                modal._element.remove();
            });
        } else {
            showAlert('Error loading report details: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error viewing report details:', error);
        showAlert('Error loading report details. Please try again.', 'danger');
    });
}

function editReport(reportId) {
    showAlert('Loading report for editing...', 'info');
    
    fetch(`/admin/reports/${reportId}`, {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const report = data.report;
            const modalContent = `
                <div class="modal fade" id="editReportModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Report - ${reportId}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editReportForm">
                                    <div class="mb-3">
                                        <label class="form-label">Content/URL</label>
                                        <textarea class="form-control" name="content" rows="3" required>${report.content || ''}</textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Type</label>
                                        <select class="form-select" name="type" required>
                                            <option value="phishing" ${report.type === 'phishing' ? 'selected' : ''}>Phishing</option>
                                            <option value="malware" ${report.type === 'malware' ? 'selected' : ''}>Malware</option>
                                            <option value="spam" ${report.type === 'spam' ? 'selected' : ''}>Spam</option>
                                            <option value="scam" ${report.type === 'scam' ? 'selected' : ''}>Scam</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" name="status" required>
                                            <option value="pending" ${report.status === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="investigating" ${report.status === 'investigating' ? 'selected' : ''}>Investigating</option>
                                            <option value="resolved" ${report.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                            <option value="dismissed" ${report.status === 'dismissed' ? 'selected' : ''}>Dismissed</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" name="description" rows="2">${report.description || ''}</textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="saveReportEdit('${reportId}')">Save Changes</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
            const modal = new bootstrap.Modal(document.getElementById('editReportModal'));
            modal.show();
            
            modal._element.addEventListener('hidden.bs.modal', function () {
                modal._element.remove();
            });
        } else {
            showAlert('Error loading report for editing: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error loading report for editing:', error);
        showAlert('Error loading report. Please try again.', 'danger');
    });
}

function saveReportEdit(reportId) {
    const form = document.getElementById('editReportForm');
    const formData = new FormData(form);
    
    fetch(`/admin/reports/${reportId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editReportModal'));
            modal.hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving report:', error);
        showAlert('Error saving report. Please try again.', 'danger');
    });
}

function markReportResolved(reportId) {
    if (confirm('Mark this report as resolved?')) {
        showAlert('Marking report as resolved...', 'info');
        
        fetch(`/admin/reports/${reportId}/resolve`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error resolving report:', error);
            showAlert('Error resolving report. Please try again.', 'danger');
        });
    }
}

function deleteReport(reportId) {
    if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
        showAlert('Deleting report...', 'info');
        
        fetch(`/admin/reports/${reportId}/delete`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error deleting report:', error);
            showAlert('Error deleting report. Please try again.', 'danger');
        });
    }
}

// Initialize confidence threshold display
document.addEventListener('DOMContentLoaded', function() {
    const confidenceSlider = document.getElementById('confidenceThreshold');
    const confidenceDisplay = document.getElementById('confidenceValue');
    
    if (confidenceSlider && confidenceDisplay) {
        confidenceSlider.addEventListener('input', function() {
            confidenceDisplay.textContent = Math.round(this.value * 100) + '%';
        });
        // Initialize display
        confidenceDisplay.textContent = Math.round(confidenceSlider.value * 100) + '%';
    }
    
    // Add event listeners for all sliders
    const learningRateSlider = document.getElementById('learningRate');
    const learningRateDisplay = document.getElementById('learningRateValue');
    
    if (learningRateSlider && learningRateDisplay) {
        learningRateSlider.addEventListener('input', function() {
            learningRateDisplay.textContent = parseFloat(this.value).toFixed(4);
        });
        learningRateDisplay.textContent = parseFloat(learningRateSlider.value).toFixed(4);
    }
    
    const batchSizeSlider = document.getElementById('batchSize');
    const batchSizeDisplay = document.getElementById('batchSizeValue');
    
    if (batchSizeSlider && batchSizeDisplay) {
        batchSizeSlider.addEventListener('input', function() {
            batchSizeDisplay.textContent = this.value;
        });
        batchSizeDisplay.textContent = batchSizeSlider.value;
    }
    
    const maxFeaturesSlider = document.getElementById('maxFeatures');
    const maxFeaturesDisplay = document.getElementById('maxFeaturesValue');
    
    if (maxFeaturesSlider && maxFeaturesDisplay) {
        maxFeaturesSlider.addEventListener('input', function() {
            maxFeaturesDisplay.textContent = this.value;
        });
        maxFeaturesDisplay.textContent = maxFeaturesSlider.value;
    }
    
    // Initialize search functionality
    const userSearch = document.getElementById('userSearch');
    if (userSearch) {
        userSearch.addEventListener('input', function() {
            filterTable('users', this.value);
        });
    }
    
    const reportSearch = document.getElementById('reportSearch');
    if (reportSearch) {
        reportSearch.addEventListener('input', function() {
            filterTable('reports', this.value);
        });
    }
});

function filterTable(tableType, searchTerm) {
    // Simple table filtering functionality would be implemented here
    console.log(`Filtering ${tableType} table for: ${searchTerm}`);
}

// Report Management Functions
function approveReport(reportId) {
    if (confirm('Approve this report?')) {
        showAlert('Approving report...', 'info');
        
        fetch(`/admin/reports/approve/${reportId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                // Remove the report row immediately instead of reloading
                const reportRow = document.querySelector(`tr[data-report-id="${reportId}"]`);
                if (reportRow) {
                    reportRow.style.transition = 'opacity 0.3s';
                    reportRow.style.opacity = '0';
                    setTimeout(() => reportRow.remove(), 300);
                }
            } else {
                showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error approving report:', error);
            showAlert('Error approving report. Please try again.', 'danger');
        });
    }
}

function rejectReport(reportId) {
    if (confirm('Reject this report?')) {
        showAlert('Rejecting report...', 'info');
        
        fetch(`/admin/reports/reject/${reportId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                // Remove the report row immediately instead of reloading
                const reportRow = document.querySelector(`tr[data-report-id="${reportId}"]`);
                if (reportRow) {
                    reportRow.style.transition = 'opacity 0.3s';
                    reportRow.style.opacity = '0';
                    setTimeout(() => reportRow.remove(), 300);
                }
            } else {
                showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error rejecting report:', error);
            showAlert('Error rejecting report. Please try again.', 'danger');
        });
    }
}

function toggleAllReports() {
    const selectAllCheckbox = document.getElementById('selectAllReports');
    const reportCheckboxes = document.querySelectorAll('.report-checkbox');
    
    reportCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

function getSelectedReports() {
    const selectedCheckboxes = document.querySelectorAll('.report-checkbox:checked');
    return Array.from(selectedCheckboxes).map(checkbox => checkbox.getAttribute('data-report-id'));
}

function approveReport(reportId) {
    if (confirm('Approve this report?')) {
        showAlert('Approving report...', 'info');
        
        fetch(`/admin/reports/approve/${reportId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Report approved successfully', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error approving report:', error);
            showAlert('Error approving report. Please try again.', 'danger');
        });
    }
}

function rejectReport(reportId) {
    if (confirm('Reject this report?')) {
        showAlert('Rejecting report...', 'info');
        
        fetch(`/admin/reports/reject/${reportId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Report rejected successfully', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error rejecting report:', error);
            showAlert('Error rejecting report. Please try again.', 'danger');
        });
    }
}

function approveSelectedReports() {
    const selectedReports = getSelectedReports();
    
    if (selectedReports.length === 0) {
        showAlert('Please select reports to approve.', 'warning');
        return;
    }
    
    if (confirm(`Approve ${selectedReports.length} selected reports?`)) {
        showAlert('Approving selected reports...', 'info');
        
        fetch('/admin/reports/bulk-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                report_ids: selectedReports,
                action: 'approve'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error approving reports:', error);
            showAlert('Error approving reports. Please try again.', 'danger');
        });
    }
}

function rejectSelectedReports() {
    const selectedReports = getSelectedReports();
    
    if (selectedReports.length === 0) {
        showAlert('Please select reports to reject.', 'warning');
        return;
    }
    
    if (confirm(`Reject ${selectedReports.length} selected reports?`)) {
        showAlert('Rejecting selected reports...', 'info');
        
        fetch('/admin/reports/bulk-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                report_ids: selectedReports,
                action: 'reject'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Error: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error rejecting reports:', error);
            showAlert('Error rejecting reports. Please try again.', 'danger');
        });
    }
}

function getSelectedReports() {
    const checkboxes = document.querySelectorAll('.report-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.dataset.reportId);
}
</script>
{% endblock %}